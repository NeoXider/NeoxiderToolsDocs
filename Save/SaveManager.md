# Менеджер SaveManager

## 1. Введение

`SaveManager` — это ядро всей системы сохранения. Это синглтон, который оркестрирует процесс поиска, сохранения и загрузки всех "сохраняемых" данных в игре. Он работает в связке с интерфейсом `ISaveableComponent` и атрибутом `[SaveField]`.

Менеджер автоматически инициализируется при старте игры, загружает все данные из `PlayerPrefs`, а также автоматически сохраняет всё при выходе из приложения. **Он также обеспечивает корректную работу сохранения и загрузки при смене сцен, автоматически регистрируя новые объекты и предотвращая повторную загрузку для уже существующих.** Это обеспечивает надежное сохранение состояния игры без необходимости вызывать методы сохранения вручную.

---

## 2. Описание класса

### SaveManager
- **Пространство имен**: `Neo.Save`
- **Путь к файлу**: `Assets/Neoxider/Scripts/Save/SaveManager.cs`

**Описание**
Центральный класс-синглтон, управляющий всем процессом сохранения и загрузки данных в игре.

**Ключевые особенности**
- **Автоматизация**: Автоматически загружает данные при старте и сохраняет при выходе.
- **Обнаружение объектов и работа со сценами**: При инициализации и при каждой загрузке новой сцены автоматически находит все активные и неактивные `MonoBehaviour`, реализующие `ISaveableComponent`, и регистрирует их. Поля для сохранения должны быть помечены атрибутом `[SaveField]`.
- **Интеллектуальная загрузка при смене сцен**: Предотвращает повторную загрузку данных для объектов, помеченных `DontDestroyOnLoad`, которые уже были загружены в предыдущих сценах. Загрузка происходит только для вновь появившихся объектов.
- **Устойчивость к изменениям схемы данных**: Система спроектирована так, чтобы корректно обрабатывать добавление или удаление полей в сохраняемых классах между версиями игры. Новые поля будут инициализированы значениями по умолчанию, а удаленные поля из старых сохранений будут игнорироваться.
- **Сериализация в JSON**: Все помеченные `[SaveField]` поля сериализуются в единый JSON-объект, который хранится в `PlayerPrefs`.
- **Коллбэк `OnDataLoaded()`**: Интерфейс `ISaveableComponent` предоставляет метод `OnDataLoaded()`, который вызывается на компоненте после успешной загрузки его данных.
- **Ручное управление**: Предоставляет статические методы для принудительного сохранения или загрузки всех объектов или одного конкретного объекта.

**Публичные методы**
- `IsLoad`: `bool` - **(Статическое свойство)** Возвращает `true`, если менеджер сохранения уже инициализирован и данные загружены.
- `Register(MonoBehaviour monoObj)`: Регистрирует компонент в менеджере. Обычно вызывается автоматически из `SaveableBehaviour`. Возвращает `void`.
- `Unregister(MonoBehaviour monoObj)`: Удаляет компонент из менеджера. Возвращает `void`.
- `Save()`: Статический метод. Сохраняет данные всех зарегистрированных компонентов. Возвращает `void`.
- `Load(List<MonoBehaviour> componentsToLoad = null)`: Статический метод. Загружает данные для указанных компонентов. Если `componentsToLoad` не предоставлен (или `null`), загружает данные для всех зарегистрированных компонентов. Возвращает `void`.
- `Save(MonoBehaviour monoObj, bool isSave = false)`: Статический метод. Сохраняет данные только для одного указанного компонента. `isSave` определяет, нужно ли немедленно записывать данные на диск. Возвращает `void`.
- `Load(MonoBehaviour monoObj)`: Статический метод. Загружает данные для одного указанного компонента. Возвращает `void`.
